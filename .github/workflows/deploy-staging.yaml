name: Deploy to Staging

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git push

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::889786867297:role/GitHubActionsRole
          aws-region: us-west-2

      - name: Configure Git for CodeCommit
        run: |
          git config --global credential.helper '!aws codecommit credential-helper $@'
          git config --global credential.UseHttpPath true

      - name: Push to CodeCommit Staging
        run: |
          echo "Adding CodeCommit remote..."
          git remote add staging https://git-codecommit.us-west-2.amazonaws.com/v1/repos/Standards || true

          echo "Pushing to CodeCommit..."
          git push staging main --force

          echo "âœ… Successfully pushed to staging CodeCommit repository"
          echo "CodeBuild will now build and deploy the Lambda function"

      - name: Report deployment status
        if: success()
        run: |
          echo "::notice::Staging deployment initiated for commit ${{ github.sha }}"
          echo "Monitor CodeBuild progress in AWS Console: https://us-west-2.console.aws.amazon.com/codesuite/codebuild/889786867297/projects/StandardsMigrationBuilder"
